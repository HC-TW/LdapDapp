extends layout

block content
    .row
        .col
            .card
                .card-header
                    h4.font-weight-bold(style="margin:0;")
                        | #{title}
                .card-body
                    table.mt-2.table.table-striped
                        thead
                            tr
                                th(scope='col') Attributes
                                th(scope='col') Value
                        tbody
                            each val, idx in user
                                tr
                                    td #{idx}
                                    td #{val}
    
    br

    button.btn.btn-block.btn-outline-info.bind-btn(type='button' data-toggle='modal' data-target='#bindModal') 使用 Metamask 綁定帳號

    #bindModal.modal.fade(tabindex='-1' role='dialog' aria-hidden='true')
        .modal-dialog(role='document')
            .modal-content
                .card.text-center
                    .card-header(style="font-size: 1.5rem; font-weight:bold")
                        | 帳號綁定
                        button.close(type='button' data-dismiss='modal' aria-label='Close')
                            span(aria-hidden='true') ×
                .card-body
                    h5.card-title 
                    form(action='/users/register' method='post')
                        .input-group
                            .input-group-prepend
                                span.input-group-text(id='') Ethereum address
                            input.form-control#address(type='text' name='address' placeholder="Address" required="required")
                        
                        .input-group.mt-3
                            .input-group-prepend
                                span.input-group-text(id='') 身份證字號
                            input.form-control#identityId(type='text' name='identityId' placeholder="Identity card ID" required="required")

                        input.btn.btn-info.btn-lg.btn-block.mt-4.submit-bind-btn(type='button' value='送出')


    script. 
        $(function() {
    
            $(".modal").on("hidden.bs.modal", function() {
                $(this).find('form').trigger('reset');
            });

            $(".bind-btn").on("click", function(e) {
                $.getScript( "/javascripts/web3_bundle.js", function(data, textStatus, jqxhr) {
                    if (typeof(web3) !== "undefined") {
                        let account = web3.eth.accounts[0];
                        $('#address').val(account);
                        $('#address').attr("readonly", "readonly");
                        $('#address').attr("style", "background-color: white;");
                    }
                });
                let id = "#{user.id}";
                if (id === "") {
                    // TODO: reset the input
                }
                else {
                    $("#identityId").val(id);
                    $('#identityId').attr("readonly", "readonly");
                    $('#identityId').attr("style", "background-color: white;");
                }
            });

            $(".submit-bind-btn").on("click", function(e) {
                let input_0 = $("#identityId").val();
                let input_1 = $("#address").val();

                $.ajax({
                    url: 'bindAccount',
                    data: { uid: input_0, address: input_1},
                    type: 'post',
                    cache: false,
                    dataType: 'json',
                    success: function(res) {
                        alert(res.msg);
                    },
                    error: function(err) {
                        alert(err);
                    }
                });

                $('#bindModal').modal('toggle');
            });
        });